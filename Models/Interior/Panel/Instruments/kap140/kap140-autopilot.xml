<?xml version="1.0" encoding="UTF-8"?>

<!-- KAP 140 Autopilot Configuration -->
<!-- Each component is evaluated in the order specified.  You can make up -->
<!-- property names to pass the result of one component on to a subsequent -->
<!-- component. -->
<PropertyList>

  <filter>
    <name>heading bug error computer/normalizer</name>
    <debug>false</debug>
    <type>gain</type>
    <input>
      <property>autopilot/settings/heading-bug-deg</property>
      <offset>
        <property>instrumentation/heading-indicator/indicated-heading-deg</property>
        <scale>-1.0</scale>
      </offset>
    </input>
    <output>autopilot/internal/heading-bug-error-deg</output>
    <period>
      <min>-180</min>
      <max>180</max>
    </period>
  </filter>

  <filter>
    <name>ils heading error computer/normalizer</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <property>instrumentation/nav-source/nav-loc</property>
        <greater-than>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>3</value>
        </greater-than>
      </condition>
    </enable>

    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>4</value>
        </equals>
      </condition>
      <expression>
        <sum>
          <dif>
            <property>orientation/heading-magnetic-deg</property>
            <property>orientation/heading-deg</property>
          </dif>
          <property>instrumentation/nav-source/target-radial-deg</property>
        </sum>
      </expression>
      <offset>
        <property>orientation/heading-magnetic-deg</property>
        <scale>-1.0</scale>
      </offset>
    </input>

    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>5</value>
        </equals>
      </condition>
      <expression>
        <sum>
          <dif>
            <property>orientation/heading-magnetic-deg</property>
            <property>orientation/heading-deg</property>
          </dif>
          <property>instrumentation/nav-source/target-radial-deg</property>
          <value>180.0</value>
        </sum>
      </expression>
      <offset>
        <property>orientation/heading-magnetic-deg</property>
        <scale>-1.0</scale>
      </offset>
    </input>

    <output>autopilot/internal/ils-error-deg</output>
    <period>
      <min>-180</min>
      <max>180</max>
    </period>
  </filter>

<!--
    ===============================================================
    Roll Axis Modes
    ===============================================================
-->

  <!-- Wing leveler (ROL) Mode -->
  <pid-controller>
    <name>Wing Leveler (ROL) Mode</name>
    <debug>false</debug>
    <enable>
      <condition>
        <greater-than>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>0</value>
        </greater-than>
      </condition>
    </enable>
    <input>instrumentation/turn-indicator/indicated-turn-rate</input>
    <reference>autopilot/internal/target-roll-deg</reference>
    <output>autopilot/kap140/servo/aileron</output>
    <config>
      <Kp>0.5</Kp>        <!-- proportional gain -->
      <beta>1.0</beta>     <!-- input value weighing factor -->
      <alpha>0.1</alpha>   <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>   <!-- input value weighing factor for -->
                           <!-- unfiltered derivative error -->
      <Ti>15.0</Ti>        <!-- integrator time -->
      <Td>0.0</Td>         <!-- derivator time -->
      <u_min>-1.0</u_min> <!-- minimum output clamp -->
      <u_max>1.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Heading Select (HDG) Mode -->
  <pid-controller>
    <name>Heading Select (HDG) Mode</name>
    <debug>false</debug>
    <enable>
      <condition>
        <greater-than>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>1</value>
        </greater-than>
      </condition>
    </enable>

<!-- NAV without HSI -->
    <input>
      <condition>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>3</value>
        </equals>
        <property>instrumentation/nav-source/in-range</property>
      </condition>
      <expression>
        <sum>
          <property>autopilot/internal/heading-bug-error-deg</property>
          <property>autopilot/internal/target-intercept-angle</property>
        </sum>
      </expression>
    </input>

<!-- NAV with HSI -->
    <input>
      <condition>
        <property>autopilot/kap140/config/hsi-installed</property>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>3</value>
        </equals>
        <property>instrumentation/nav-source/in-range</property>
      </condition>
      <expression>
        <sum>
          <property>instrumentation/nav-source/course-error</property>
          <property>autopilot/internal/target-intercept-angle</property>
        </sum>
      </expression>
    </input>

<!-- APR without HSI on ILS -->
    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>4</value>
        </equals>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <property>instrumentation/nav-source/in-range</property>
        <property>instrumentation/nav-source/nav-loc</property>
      </condition>
      <expression>
        <sum>
          <property>autopilot/internal/ils-error-deg</property>
          <property>autopilot/internal/target-intercept-angle</property>
        </sum>
      </expression>
    </input>

<!-- APR without HSI on VOR -->
    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>4</value>
        </equals>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <property>instrumentation/nav-source/in-range</property>
      </condition>
      <expression>
        <sum>
          <property>autopilot/internal/heading-bug-error-deg</property>
          <property>autopilot/internal/target-intercept-angle</property>
        </sum>
      </expression>
    </input>

<!-- REV without HSI on ILS -->
    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>5</value>
        </equals>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <property>instrumentation/nav-source/in-range</property>
        <property>instrumentation/nav-source/nav-loc</property>
      </condition>
      <expression>
        <dif>
          <sum>
            <property>autopilot/internal/ils-error-deg</property>
            <value>180</value>
          </sum>
          <property>autopilot/internal/target-intercept-angle</property>
        </dif>
      </expression>
      <period>
        <min>-180</min>
        <max>180</max>
      </period>
    </input>

<!-- REV without HSI on VOR -->
    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>5</value>
        </equals>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <property>instrumentation/nav-source/in-range</property>
      </condition>
      <expression>
        <dif>
          <sum>
            <property>autopilot/internal/heading-bug-error-deg</property>
            <value>180</value>
          </sum>
          <property>autopilot/internal/target-intercept-angle</property>
        </dif>
      </expression>
      <period>
        <min>-180</min>
        <max>180</max>
      </period>
    </input>

<!-- HDG without HSI and REV armed -->
    <input>
      <condition>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <equals>
          <property>autopilot/kap140/settings/lateral-arm</property>
          <value>3</value>
        </equals>
        <less-than>
          <property>autopilot/kap140/panel/hdg-timer</property>
          <value>1</value>
        </less-than>
      </condition>
      <expression>
        <dif>
          <sum>
            <property>autopilot/internal/heading-bug-error-deg</property>
            <value>180</value>
          </sum>
          <property>autopilot/internal/target-intercept-angle</property>
        </dif>
      </expression>
      <period>
        <min>-180</min>
        <max>180</max>
      </period>
    </input>

<!-- HDG without HSI and NAV or APR armed -->
    <input>
      <condition>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <greater-than>
          <property>autopilot/kap140/settings/lateral-arm</property>
          <value>0</value>
        </greater-than>
        <less-than>
          <property>autopilot/kap140/panel/hdg-timer</property>
          <value>1</value>
        </less-than>
      </condition>
      <expression>
        <sum>
          <property>autopilot/internal/heading-bug-error-deg</property>
          <property>autopilot/internal/target-intercept-angle</property>
        </sum>
      </expression>
    </input>

<!-- HDG -->
    <input>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-arm</property>
          <value>0</value>
        </equals>
        <less-than>
          <property>autopilot/kap140/panel/hdg-timer</property>
          <value>1</value>
        </less-than>
      </condition>
      <property>autopilot/internal/heading-bug-error-deg</property>
    </input>

    <reference>0.0</reference>
    <output>autopilot/internal/target-roll-deg</output>
    <config>
      <Kp>-0.05</Kp>      <!-- proportional gain -->
      <beta>2.0</beta>    <!-- input value weighing factor -->
      <alpha>0.1</alpha>  <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>  <!-- input value weighing factor for -->
                          <!-- unfiltered derivative error -->
      <Ti>15.0</Ti>       <!-- integrator time -->
      <Td>0.0</Td>        <!-- derivator time -->
      <u_min>-1.0</u_min> <!-- minimum output clamp -->
      <u_max>1.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Heading hold (HDG) Mode -->
  <filter>
    <name>Heading hold (HDG) Mode</name>
    <debug>false</debug>
    <type>gain</type>
    <gain>75</gain>
    <enable>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>2</value>
        </equals>
        <not><property>autopilot/kap140/config/hsi-installed</property></not>
        <greater-than>
          <property>autopilot/kap140/settings/lateral-arm</property>
          <value>0</value>
        </greater-than>
        <less-than>
          <property>autopilot/kap140/panel/hdg-timer</property>
          <value>1</value>
        </less-than>
      </condition>
    </enable>
    <input>instrumentation/nav-source/heading-needle-deflection-norm</input>
    <output>autopilot/internal/target-intercept-angle</output>
    <min>-45</min>
    <max>45</max>
  </filter>

  <!-- Nav hold (NAV) Mode -->
  <pid-controller>
    <name>Nav hold (NAV) Mode</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>instrumentation/nav-source/in-range</property>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>3</value>
        </equals>
      </condition>
    </enable>
    <input>
      <expression>
        <product>
          <property>instrumentation/nav-source/heading-needle-deflection-norm</property>
          <value>-1.0</value>
        </product>
      </expression>
    </input>
    <reference>0.0</reference>
    <output>autopilot/internal/target-intercept-angle</output>
    <config>
      <Kp>200</Kp>
      <beta>0.7</beta>
      <alpha>0.5</alpha>
      <gamma>0.0</gamma>
      <Ti>100</Ti>
      <Td>0.5</Td>
      <u_min>-45.0</u_min>
      <u_max>45.0</u_max>
    </config>
  </pid-controller>

  <!-- Approach hold (APR) Mode-->
  <pid-controller>
    <name>Approach hold (APR) Mode</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>instrumentation/nav-source/in-range</property>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>4</value>
        </equals>
      </condition>
    </enable>
    <input>instrumentation/nav-source/heading-needle-deflection-norm</input>
    <reference>0.0</reference>
    <output>autopilot/internal/target-intercept-angle</output>
    <config>
      <Kp>-100.0</Kp>      <!-- proportional gain -->
      <beta>0.7</beta>     <!-- input value weighing factor -->
      <alpha>0.1</alpha>   <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>   <!-- input value weighing factor for -->
                           <!-- unfiltered derivative error -->
      <Ti>50.0</Ti>        <!-- integrator time -->
      <Td>0.5</Td>         <!-- derivator time -->
      <u_min>-45.0</u_min> <!-- minimum output clamp -->
      <u_max>45.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Backcourse hold (REV) Mode-->
  <pid-controller>
    <name>Backcourse hold (REV) Mode</name>
    <debug>false</debug>
    <enable>
      <condition>
        <property>instrumentation/nav-source/in-range</property>
        <equals>
          <property>autopilot/kap140/settings/lateral-mode</property>
          <value>5</value>
        </equals>
      </condition>
    </enable>
    <input>instrumentation/nav-source/heading-needle-deflection-norm</input>
    <reference>0.0</reference>
    <output>autopilot/internal/target-intercept-angle</output>
    <config>
      <Kp>-100.0</Kp>      <!-- proportional gain -->
      <beta>0.7</beta>     <!-- input value weighing factor -->
      <alpha>0.1</alpha>   <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>   <!-- input value weighing factor for -->
                           <!-- unfiltered derivative error -->
      <Ti>50.0</Ti>        <!-- integrator time -->
      <Td>0.5</Td>         <!-- derivator time -->
      <u_min>-45.0</u_min> <!-- minimum output clamp -->
      <u_max>45.0</u_max>  <!-- maximum output clamp -->
    </config>
  </pid-controller>

<!--
    ===============================================================
    Pitch Axis Modes
    ===============================================================
-->
  <!-- Vertical Speed (VS) Mode -->
  <pid-controller>
    <name>Vertical Speed (VS) Mode</name>
    <debug>false</debug>
    <enable>
      <condition>
        <greater-than>
          <property>autopilot/kap140/settings/vertical-mode</property>
          <value>0</value>
        </greater-than>
      </condition>
    </enable>
    <input>autopilot/internal/vert-speed-fpm</input>
    <reference>autopilot/internal/target-climb-rate</reference>
    <output>autopilot/kap140/servo/elevator</output>
    <config>
      <Kp>-0.0001</Kp>   <!-- proportional gain -->
      <beta>1.0</beta>    <!-- input value weighing factor -->
      <alpha>0.1</alpha>  <!-- low pass filter weighing factor -->
      <gamma>0.0</gamma>  <!-- input value weighing factor for -->
                          <!-- unfiltered derivative error -->
      <Ti>20.0</Ti>        <!-- integrator time -->
      <Td>0.0</Td>        <!-- derivator time -->
      <u_min>-0.5</u_min> <!-- 0.25 minimum output clamp -->
      <u_max>0.5</u_max>  <!-- 0.25 maximum output clamp -->
    </config>
  </pid-controller>

  <!-- Altitude Capture (ALT ARM) -->
  <filter>
    <name>slow down FPM while approaching ALT</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/vertical-arm</property>
          <value>1</value>
        </equals>
        <greater-than>
          <expression>
            <product>
              <abs>
                <property>autopilot/internal/vert-speed-fpm</property>
              </abs>
              <value>0.1</value>
            </product>
          </expression>
          <expression>
            <abs>
              <dif>
                <property>autopilot/internal/target-altitude</property>
                <property>instrumentation/altimeter/indicated-altitude-ft</property>
              </dif>
            </abs>
          </expression>
        </greater-than>
      </condition>
    </enable>
    <input>
      <condition>
        <less-than>
          <property>instrumentation/altimeter/indicated-altitude-ft</property>
          <property>autopilot/internal/target-altitude</property>
        </less-than>
      </condition>
      <expression>
        <product>
          <ceil>
            <product>
              <dif>
                <property>autopilot/internal/target-altitude</property>
                <property>instrumentation/altimeter/indicated-altitude-ft</property>
              </dif>
              <value>0.1</value>
            </product>
          </ceil>
          <value>100</value>
        </product>
      </expression>
    </input>
    <input>
      <expression>
        <product>
          <floor>
            <product>
              <dif>
                <property>autopilot/internal/target-altitude</property>
                <property>instrumentation/altimeter/indicated-altitude-ft</property>
              </dif>
              <value>0.1</value>
            </product>
          </floor>
          <value>100</value>
        </product>
      </expression>
    </input>
    <output>autopilot/internal/target-climb-rate</output>
  </filter>

  <!-- Altitude Hold (ALT) Mode -->
  <filter>
    <name>Altitude Hold (ALT) Mode</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/vertical-mode</property>
          <value>2</value>
        </equals>
        <equals>
          <property>autopilot/kap140/panel/button-up</property>
          <value>0</value>
        </equals>
        <equals>
          <property>autopilot/kap140/panel/button-down</property>
          <value>0</value>
        </equals>
      </condition>
    </enable>
    <input>
      <expression>
        <product>
          <dif>
            <property>environment/pressure-inhg</property>
            <property>autopilot/internal/target-pressure</property>
          </dif>
          <value>5000</value>
        </product>
      </expression>
    </input>
    <output>autopilot/internal/target-climb-rate</output>
    <min>-500</min>
    <max>500</max>
  </filter>

  <!-- Glideslope Hold (GS) Mode -->
  <filter>
    <name>Glideslope Hold (GS) Mode</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <equals>
          <property>autopilot/kap140/settings/vertical-mode</property>
          <value>3</value>
        </equals>
        <property>instrumentation/nav-source/in-range</property>
        <property>instrumentation/nav-source/nav-loc</property>
        <property>instrumentation/nav-source/gs-in-range</property>
      </condition>
    </enable>
    <input>
      <expression>
        <product>
          <property>instrumentation/nav-source/gs-rate-of-climb-fpm</property>
          <value>1.2</value>
        </product>
      </expression>
    </input>
    <output>autopilot/internal/target-climb-rate</output>
  </filter>

<!--
    ===============================================================
    Servos
    ===============================================================
-->

  <filter>
    <name>roll-servo change rate</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <equals>
          <property>autopilot/kap140/panel/state</property>
          <value>6</value>
        </equals>
      </condition>
    </enable>
    <input>
      <condition>
        <not><property>autopilot/kap140/roll-axis-fail</property></not>
        <not><property>autopilot/kap140/settings/cws</property></not>
      </condition>
      <value>1.0</value>
    </input>
    <input>0.001</input>
    <output>autopilot/kap140/servo/aileron-rate</output>
  </filter>

  <filter>
    <name>roll-servo</name>
    <debug>false</debug>
    <type>exponential</type>
    <filter-time>
    <property>autopilot/kap140/servo/aileron-rate</property>
    </filter-time>
<!--
    <type>noise-spike</type>
    <max-rate-of-change>
      <property>autopilot/kap140/servo/aileron-rate</property>
    </max-rate-of-change>
-->
    <enable>
      <condition>
        <equals>
          <property>autopilot/kap140/panel/state</property>
          <value>6</value>
        </equals>
      </condition>
    </enable>
    <input>
      <condition>
        <not><property>autopilot/kap140/roll-axis-fail</property></not>
        <not><property>autopilot/kap140/settings/cws</property></not>
      </condition>
      <property>autopilot/kap140/servo/aileron</property>
    </input>
    <input>controls/flight/aileron</input>
    <output>controls/flight/aileron</output>
  </filter>

  <filter>
    <name>pitch-servo change rate</name>
    <debug>false</debug>
    <type>gain</type>
    <enable>
      <condition>
        <greater-than>
          <property>autopilot/kap140/config/model</property>
          <value>1</value>
        </greater-than>
        <equals>
          <property>autopilot/kap140/panel/state</property>
          <value>6</value>
        </equals>
      </condition>
    </enable>
    <input>
      <condition>
        <not><property>autopilot/kap140/pitch-axis-fail</property></not>
        <not><property>autopilot/kap140/settings/cws</property></not>
      </condition>
      <value>1.0</value>
    </input>
    <input>0.001</input>
    <output>autopilot/kap140/servo/elevator-rate</output>
  </filter>

  <filter>
    <name>pitch-servo</name>
    <debug>false</debug>
    <type>exponential</type>
    <filter-time>
    <property>autopilot/kap140/servo/elevator-rate</property>
    </filter-time>
    <enable>
      <condition>
        <greater-than>
          <property>autopilot/kap140/config/model</property>
          <value>1</value>
        </greater-than>
        <equals>
          <property>autopilot/kap140/panel/state</property>
          <value>6</value>
        </equals>
      </condition>
    </enable>
    <input>
      <condition>
        <not><property>autopilot/kap140/pitch-axis-fail</property></not>
        <not><property>autopilot/kap140/settings/cws</property></not>
      </condition>
      <property>autopilot/kap140/servo/elevator</property>
    </input>
    <input>controls/flight/elevator</input>
    <output>controls/flight/elevator</output>
  </filter>

</PropertyList>
